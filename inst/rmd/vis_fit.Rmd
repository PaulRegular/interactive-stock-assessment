---
title: "NCAM Explorer"
output: flexdashboard::flex_dashboard
always_allow_html: yes
---

<style>
/* list */
li {
line-height: 30px;
}
</style>


```{r setup, echo=FALSE}
library(plotly)
library(Matrix)
library(knitr)
library(data.table)
library(webshot)
knitr::opts_knit$set(root.dir = tmp$output_dir)
knitr::opts_chunk$set(echo = FALSE, fig.height = 7, fig.width = 8)
```


```{r data, include=FALSE}

cols <- viridis::viridis(4)[-1]
cols_rgb <-  paste0("rgb(", apply(col2rgb(cols), 2, paste, collapse = ","), ")")
fit <- tmp$fit # temp object from vis_fit function
if (!is.null(tmp$comp)) { comp <- tmp$comp }
if (!is.null(tmp$last)) { last <- tmp$last }
est <- as.list(fit$sd.rep, "Est")
sd <- as.list(fit$sd.rep, "Std")
tabs <- tidy_model(fit)
if (!is.null(tmp$comp)) { comp_tabs <- tidy_model(model_list = comp) }
if (!is.null(tmp$last)) { last_tabs <- tidy_model(tmp$last) }
if (!is.null(fit$retro)) { retro_tabs <- tidy_retro(fit) } 
min_year <- min(fit$tmb.data$years)
max_year <- max(fit$tmb.data$years)
ages <- fit$tmb.data$ages
years <- fit$tmb.data$years
years_plus1 <- fit$tmb.data$years_plus1

## helper functions for nice Rmarkdown text
text_range <- function(x) paste(range(x), collapse = "-")
text_c <- function(x) {
  paste0(paste(x[-length(x)], collapse = ", "), ", and ", x[length(x)])
}
text_units <- function(x) {
  if (x >= 1000000) return(paste0(round(x / 1000000), "M"))
  if (x >= 1000) return(paste0(round(x / 1000), "k"))
  if (x < 1000) return(as.character(round(x)))
}

```



Background
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### NCAM

<h1>NCAM: A state-space stock assessment model for Northern cod</h1>

```{r}

ax <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = FALSE,
  showgrid = FALSE
)

xy <- approx(x = years_plus1, y = fit$rep$abundance + 1000000, n = 50)
plot_ly(x = xy$x, y = xy$y, hoverinfo = "none",
        fillcolor = 'rgba(49, 104, 142, 0.3)',
        type = 'scatter', mode = 'none', fill = 'tozeroy', showlegend = FALSE) %>%
  add_trace() %>%
  layout(xaxis = ax, yaxis = c(list(range = c(0, max(xy$y))), ax),
         margin = list(l = 0, r = 0, b = 0, t = 0, pad = 0)) %>% 
  plotly::config(displayModeBar = FALSE)

```


### General

- An *integrated* *state-space* population dynamics model
- *Integrated*
    - Uses as much information as possible
- *State-space*
    - Includes process and observation equations + error
    - Population processes are informed by observations from multiple sources
    - Process errors are necessary for realistic stochastic projections

### Data inputs

- Reported landings (`r text_range(years)`)
- Catch-at-age information (`r text_range(years)`)
- Reported landings by month (`r text_range(years)`)
- Offshore research vessel (RV) survey indices (`r text_range(c(1983, max(years)))`)
- Inshore sentinel (SN) gillnet survey indices (`r text_range(fit$tmb.data$SN_years)`)
- Inshore acoustic biomass surveys and age composition data from Smith Sound (SS; `r text_range(fit$tmb.data$SS_years)`)
- Tagging data (`r text_range(years)`)

### Biological inputs

- RV survey data were used fit cohort-based models of:
   - Proportion mature at age
   - Beginning of year and mid-year stock weights at age
- Baseline natural mortality (M) values

```{r}

plot_ly(x = years, y = ages, z = fit$rep$M_matrix, height = 400, width = 500) %>%
  add_surface() %>%
  colorbar(title = "Mshift") %>%
  layout(scene = list(
    xaxis = list(title = "Year"),
    yaxis = list(title = "Age"),
    zaxis = list(title = "Mshift")
  ))

```


### Partial catches

- User sets lower and upper bounds on total catch weight
- Bounds are used via a censored likelihood

```{r}

plot_ly(x = years, y = fit$tmb.data$LRL, height = 300, width = 500) %>%
  add_lines(name = "Lower", color = I(cols[1])) %>%
  add_lines(y = fit$tmb.data$LRU, name = "Upper", color = I(cols[2])) %>%
  add_lines(y = rep(1, length(years)), color = I("black"),
            line = list(width = 1, dash = "dot"), showlegend = FALSE) %>%
  layout(yaxis = list(title = "Catch multiplier"),
         xaxis = list(title = "Year"))

```

### Change in Q

- A shift in Q was assumed for the offshore RV survey
- A variable portion of the stock is assumed to occupy Smith Sound between `r text_range(fit$tmb.data$SS_years)`
- Q for the inshore sentinel survey was assumed to follow a random walk
    - Done to account for potential changes in migration patterns

### Tagging data

- Age of tagged fish estimated from length-at-release using a spatiotemporal Von Bertalanffy growth model
- Applies adjustments for tagging mortality, tag loss and reporting rates
- Reporting rates estimated by an external model using the high-reward tag data collected since 1997
- The Baranov catch equation was applied to age-based tag survivors
- Assumes that initial fishing mortality experienced by fish in each experiment are random deviations from the fishing mortality experienced by the whole stock

### References

Cadigan, N. 2015. A state-space stock assessment model for Northern cod, including under-reported catches and variable natural mortality rates. Canadian Journal of Fisheries and Aquatic Sciences 73 (2). NRC Research Press: 296-308.

Cadigan, N. 2016. Updates to a Northern cod (*Gadus morhua*) state-space integrated assessment model. DFO Can. Sci. Advis. Sec. Res. Doc. 2016/022. v + 58 p.


Catch
================================================================================

Row
--------------------------------------------------------------------------------

### Landings

```{r}

plot_landings(fit)

```


> Y-axes in log scale



Row {.tabset}
--------------------------------------------------------------------------------

### Observed and predicted catch at age

```{r}

d <- tidy_mats(list(obs = fit$tmb.data$catch_prop,
                    pred = fit$rep$pred_prop_catch),
               ages = ages, years = years)
facet_obs_pred(d, by = "age",
               which = c(2, 8, 3, 9, 4, 10, 5, 11, 6, 12, 7, 13), # done to order by column
               nrows = 6, ylab = "Proportion",
               obs_col = cols[2], pred_col = cols[1]) %>%
  layout(yaxis = list(rangemode = "tozero"))

```

### Residuals by year, cohort, age and expected values

```{r}

d <- tidy_mats(list(res = fit$rep$CA_resid,
                    fit = fit$rep$pred_crl),
               ages = ages[-length(ages)], years = years)
d$cohort <- d$year - d$age
d$rec <- seq(nrow(d))
plot_resid(d, col = cols[1])

```

> based on continuation ratio logits

### Catch at age surface (proportion)

```{r}
plot_surface(mat = fit$rep$pred_prop_catch, ages = ages, years = years, name = "P")
```

<!-- ### Catch at age surface (numbers) -->

<!-- ```{r} -->
<!-- plot_surface(mat = t(inputs$catch.num), ages = ages, years = years, name = "N") -->
<!-- ``` -->

<!-- > Note: model fits to composition - this plot is included for illustration -->


RV Survey
================================================================================

Row
--------------------------------------------------------------------------------

### RV survey index

```{r}

obs <- colSums(fit$tmb.data$est_wt * fit$tmb.data$RV_index * fit$tmb.data$trawl_units)
pred <- colSums(fit$tmb.data$est_wt * exp(fit$rep$Elog_RV_index) * fit$tmb.data$trawl_units)
obs[obs == 0] <- NA
pred[pred == 0] <- NA
d <- data.frame(year = years, obs = obs, pred = pred)

# ## RV biomass
# obs <- colSums(fit$tmb.data$RV_index * fit$tmb.data$trawl_units * fit$tmb.data$weight)
# pred <- colSums(exp(fit$rep$Elog_RV_index) * fit$tmb.data$trawl_units * fit$tmb.data$weight)
# d <- data.frame(year = years, obs = obs, pred = pred)
# write.table(d, file = "clipboard", sep = "\t", row.names = FALSE, quote = FALSE)

plot_obs_pred(d, obs_col = cols[2], pred_col = cols[1], ylab = "RV survey index",
              showlegend = TRUE, type = "log")

```

> Y-axes in log scale


### Standardized log residuals

```{r}

d <- tidy_mats(list(res = fit$rep$RV_resid,
                    zero = fit$tmb.data$ind_zero,
                    wt = fit$tmb.data$est_wt),
               ages = ages, years = years)
d <- d[d$wt == 1, ]
bubble_plot(d)

```

Row {.tabset}
--------------------------------------------------------------------------------

### RV survey index at age

```{r}

d <- tidy_mats(list(obs = fit$tmb.data$RV_index,
                    pred = exp(fit$rep$Elog_RV_index),
                    wt = fit$tmb.data$est_wt),
               ages = ages, years = years)
d$obs[d$wt == 0] <- NA
d$pred[d$wt == 0] <- NA
facet_obs_pred(d, by = "age",
               which = c(2, 8, 3, 9, 4, 10, 5, 11, 6, 12, 7, 13), # done to order by column
               nrows = 6, ylab = "Mean numbers per tow",
               obs_col = cols[2], pred_col = cols[1], type = "log")

```

> Y-axes in log scale

### Residuals by year, cohort, age and expected values

```{r}

d <- tidy_mats(list(res = fit$rep$RV_resid,
                    keep = fit$tmb.data$ind_zero == 0 & fit$tmb.data$est_wt == 1,
                    fit = fit$rep$Elog_RV_index),
               ages = ages, years = years)
d <- d[d$keep, ]
d$cohort <- d$year - d$age
d$rec <- seq(nrow(d))
plot_resid(d, col = cols[1])

```



SN Survey
================================================================================

Row
--------------------------------------------------------------------------------

### Sentinel gillnet survey index

```{r}

obs <- colSums(fit$tmb.data$SN_GN_index)
pred <- colSums(exp(fit$rep$Elog_SN_GN_index))
d <- data.frame(year = fit$tmb.data$SN_years, obs = obs, pred = pred)

plot_obs_pred(d, obs_col = cols[2], pred_col = cols[1], ylab = "Sentinel survey index",
              showlegend = TRUE, type = "log")

```

> Y-axes in log scale


### Standardized log residuals

```{r}

d <- tidy_mat(fit$rep$log_SN_GN_resid,
              ages = fit$tmb.data$SN_ages,
              years = fit$tmb.data$SN_years, value = "res")
bubble_plot(d)

```

Row {.tabset}
--------------------------------------------------------------------------------

### Sentinel gillnet survey index at age

```{r}

d <- tidy_mats(list(obs = fit$tmb.data$SN_GN_index,
                    pred = exp(fit$rep$Elog_SN_GN_index)),
               ages = fit$tmb.data$SN_ages, years = fit$tmb.data$SN_years)
facet_obs_pred(d, by = "age",
               which = c(3, 7, 4, 8, 5, 9, 6, 10), # done to order by column
               nrows = 4, ylab = "Sentinel survey index",
               obs_col = cols[2], pred_col = cols[1], type = "log")

```

> Y-axes in log scale

### Residuals by year, cohort, age and expected values

```{r}

d <- tidy_mats(list(res = fit$rep$log_SN_GN_resid,
                    fit = fit$rep$Elog_SN_GN_index),
               ages = fit$tmb.data$SN_ages,
               years = fit$tmb.data$SN_years)
d$cohort <- d$year - d$age
d$rec <- seq(nrow(d))
plot_resid(d, col = cols[1])

```



SS Survey
================================================================================

Row
--------------------------------------------------------------------------------

### Smith sound acoustic biomass estimates

```{r}

d <- data.frame(year = fit$tmb.data$SS_bms_years,
                obs = fit$tmb.data$SSbms,
                pred = fit$rep$ESSbms)
plot_obs_pred(d, obs_col = cols[2], pred_col = cols[1], ylab = "Biomass (t)",
              showlegend = TRUE)

```


### Standardized log residuals

```{r}

d <- tidy_mat(fit$rep$SS_agecomps_resid_std,
              ages = fit$tmb.data$SS_ages,
              years = fit$tmb.data$SS_age_years, value = "res")
bubble_plot(d)

```

Row {.tabset}
--------------------------------------------------------------------------------

### Smith Sound trawl numbers at age

```{r}

d <- tidy_mats(list(obs = fit$tmb.data$SS_agecomps,
                    pred = fit$rep$ESS_agecomps),
               ages = fit$tmb.data$SS_ages,
               years = fit$tmb.data$SS_age_years)
facet_obs_pred(d, by = "age",
               which = c(2, 8, 3, 9, 4, 10, 5, 11, 6, 12, 7, 13), # done to order by column
               nrows = 6, ylab = "Numbers caught", rangemode = "tozero",
               obs_col = cols[2], pred_col = cols[1])

```


### Residuals by year, cohort, age and expected values

```{r}

d <- tidy_mats(list(res = fit$rep$SS_agecomps_resid_std,
                    fit = fit$rep$ESS_agecomps),
               ages = fit$tmb.data$SS_ages,
               years = fit$tmb.data$SS_age_years)
d$cohort <- d$year - d$age
d$rec <- seq(nrow(d))
plot_resid(d, col = cols[1])

```


Tagging {data-orientation=rows}
================================================================================

```{r}

## Prep tag data and fits
tag_dat <- data.frame(
  exp = c(fit$tmb.data$old_tag_exp, fit$tmb.data$tag_exp),
  n_rel = c(fit$tmb.data$old_N_rel, fit$tmb.data$N_rel),
  rel_year = c(fit$tmb.data$old_rel_year, fit$tmb.data$rel_year) + min(years),
  cap_year = c(fit$tmb.data$old_cap_year, fit$tmb.data$cap_year) + min(years),
  age = c(fit$tmb.data$old_tag_age, fit$tmb.data$tag_age),
  pred = c(fit$rep$old_tag_report, fit$rep$tag_report),
  obs = c(fit$tmb.data$old_N_cap, fit$tmb.data$N_cap),
  res = c(fit$rep$old_tag_std_resid, fit$rep$tag_std_resid),
  period = c(rep("pre 1996", length(fit$tmb.data$old_tag_exp)),
             rep("post 1996", length(fit$tmb.data$tag_exp)))
)
tag_dat$delay <- tag_dat$cap_year - tag_dat$rel_year
tag_dat$text <- paste("exp:", tag_dat$exp, "</br>",
                      "age:", tag_dat$age, "</br>",
                      "delay:", tag_dat$delay, "</br>")

Udev <- data.frame(
  exp = c(unique(fit$tmb.data$old_tag_exp), unique(fit$tmb.data$tag_exp)),
  Udev = c(fit$rep$old_Udev, fit$rep$Udev)
)

Fay <- tidy_mat(fit$rep$F_matrix, ages = ages, years = years, value = "Fay")
names(Fay)[names(Fay) == "year"] <- "rel_year"

tag_dat <- merge(tag_dat, Udev, by = "exp")
tag_dat <- merge(tag_dat, Fay, by = c("rel_year", "age"))
tag_dat$Fsay <- tag_dat$Fay * exp(tag_dat$Udev)

## Share data across multiple plots
d <- crosstalk::SharedData$new(tag_dat, ~exp, "Select an experiment")
base <- plot_ly(d, symbol = ~period, colors = cols[1:2], symbols = c(16, 1)) %>% group_by(exp)

```


Row {data-height=700 .tabset}
--------------------------------------------------------------------------------

### Observed and predicted tag recaptures by experimemnt

```{r}

y_ticktext <- c(50, 500, pretty(c(0, 6000), 4))
y_tickvals <- sqrt(y_ticktext)

rel_plot <- base %>%
  filter(rel_year == cap_year) %>%
  group_by(exp) %>%
  summarise(rel_year = unique(rel_year), tot_rel = sum(n_rel), period = unique(period)) %>%
  add_markers(x = ~rel_year, y = ~sqrt(tot_rel), color = I(cols[1]),
              text = ~paste("exp:", exp, "</br>", "N:", tot_rel)) %>%
  layout(shapes = list(type = "line", x0 = 1996, x1 = 1996,
                       y0 = 0, y1 = 1000, yref = "y",
                       line = list(width = 1, dash = "dot")),
         yaxis = list(title = "N released",
                      tickvals = y_tickvals,
                      ticktext = y_ticktext,
                      range = range(y_tickvals)),
         xaxis = list(title = "Year"))

y_ticktext <- c(5, 20, pretty(c(0, 500), 10))
y_tickvals <- sqrt(y_ticktext)

cap_plot <- base %>%
  group_by(exp, rel_year, cap_year) %>%
  summarise(sum_pred = sum(pred), sum_obs = sum(obs),
            period = unique(period)) %>%
  group_by(exp) %>%
  add_markers(x = ~cap_year, y = ~sqrt(sum_obs), color = I(cols[1]), name = "",
              showlegend = FALSE, text = ~paste("exp:", exp, "</br>", "observed N:", sum_obs)) %>%
  add_lines(x = ~cap_year, y = ~sqrt(sum_pred), color = I(cols[2]), name = "Predicted",
            alpha = 0.7, showlegend = FALSE, symbol = NULL,
            text = ~paste("exp:", exp, "</br>", "predicted N:", round(sum_pred))) %>%
  layout(shapes = list(type = "line", x0 = 1996, x1 = 1996,
                       y0 = 0, y1 = 1000, yref = "y2",
                       line = list(width = 1, dash = "dot")),
         yaxis = list(title = "N recaptured",
                      tickvals = y_tickvals,
                      ticktext = y_ticktext,
                      range = range(y_tickvals)),
         xaxis = list(title = "Year"))


subplot(rel_plot, cap_plot, shareX = TRUE, titleX = TRUE, titleY = TRUE,
        nrows = 2, heights = c(0.3, 0.7))


```

> Y-axis is in square root scale

<!-- ### Animation -->

<!-- ```{r} -->

<!-- sum_d <- tag_dat %>% -->
<!--   group_by(exp, cap_year) %>% -->
<!--   summarise(sum_pred = sum(pred), sum_obs = sum(obs)) -->

<!-- sum_d %>%  -->
<!--   group_by(exp) %>%  -->
<!--   plot_ly(x = ~cap_year, frame = ~exp) %>% -->
<!--   add_markers(y = ~sqrt(sum_obs), color = I(cols[1]), name = "Observed", -->
<!--               text = ~paste("exp:", exp, "</br>", "observed N:", sum_obs)) %>% -->
<!--   add_lines(y = ~sqrt(sum_pred), color = I(cols[2]), name = "Predicted", -->
<!--             text = ~paste("exp:", exp, "</br>", "predicted N:", round(sum_pred))) %>% -->
<!--   animation_opts(1000, transition = 500, easing = "exp", redraw = FALSE) %>% -->
<!--   layout(yaxis = list(title = "N recaptured", -->
<!--                       tickvals = y_tickvals, -->
<!--                       ticktext = y_ticktext, -->
<!--                       range = range(y_tickvals)), -->
<!--          xaxis = list(title = "Year")) -->

<!-- ``` -->




Row
--------------------------------------------------------------------------------

### Tag reporting rate

```{r}

cov_mat <- Matrix::as.matrix(fit$tmb.data$SRR_cov_matrix)
rr <- data.frame(year = fit$tmb.data$SRR_years,
                 est = fit$tmb.data$log_SRR_est,
                 sd = sqrt(diag(cov_mat)))
rr$lwr <- rr$est - 1.96 * rr$sd
rr$upr <- rr$est + 1.96 * rr$sd
rr <- trans_est(rr)
rr$model <- "Random Walk"

ncam_rr <- data.frame(year = fit$tmb.data$SRR_years,
                      est = est$log_SRR, sd = sd$log_SRR)
ncam_rr$lwr <- ncam_rr$est - 1.96 * ncam_rr$sd
ncam_rr$upr <- ncam_rr$est + 1.96 * ncam_rr$sd
ncam_rr <- trans_est(ncam_rr)
ncam_rr$model <- "NCAM"

rr <- rbind(rr, ncam_rr)

plot_trend(rr, group = "model", col = cols, ylab = "Reporting rates", annotate = TRUE)


```


### Initial F deviations for tagging experiments


```{r}

base %>%
  distinct(rel_year, Udev, exp, period) %>%
  add_markers(x = ~rel_year, y = ~Udev, text = ~exp, color = I(cols[1]),
              showlegend = FALSE) %>%
  layout(shapes = list(type = "line", x0 = 1996, x1 = 1996,
                       y0 = min(tag_dat$Udev), y1 = max(tag_dat$Udev),
                       line = list(width = 1, dash = "dot")),
         yaxis = list(title = "Initial F deviation"),
         xaxis = list(title = "Year"))

```


### Observed vs. predicted recaptures

```{r}

x_ticktext <- c(5, pretty(tag_dat$pred, 10))
y_ticktext <- c(5, pretty(tag_dat$obs, 10))
x_tickvals <- sqrt(x_ticktext)
y_tickvals <- sqrt(y_ticktext)

base %>%
  add_markers(x = ~sqrt(pred), y = ~sqrt(obs),
              text = ~text, color = I(cols[1]), showlegend = FALSE) %>%
  layout(shapes = list(type = "line", x0 = 0, x1 = max(sqrt(c(tag_dat$pred, tag_dat$obs))),
                       y0 = 0, y1 = max(sqrt(c(tag_dat$pred, tag_dat$obs))),
                       line = list(width = 1)),
         xaxis = list(title = "Predicted number of recaptures",
                      tickvals = x_tickvals,
                      ticktext = x_ticktext),
         yaxis = list(title = "Observed number of recaptures",
                      tickvals = y_tickvals,
                      ticktext = y_ticktext))


```

> Axes are in square root scale

### Standardized residuals vs. predicted recaptures

```{r}

y_ticktext <- c(5, pretty(tag_dat$res, 10))
y_tickvals <- sqrt(x_ticktext)

base %>%
  add_markers( x = ~sqrt(pred), y = ~res,
               text = ~text, color = I(cols[1]), showlegend = FALSE) %>%
  layout(xaxis = list(title = "Predicted number of recaptures",
                      tickvals = x_tickvals,
                      ticktext = x_ticktext),
         yaxis = list(title = "Standardized residuals"))

```

> X-axis is in square root scale



Catchability
================================================================================


Row {.tabset}
--------------------------------------------------------------------------------


### Fishery selectivity

```{r}

S <- apply(fit$rep$F_matrix, 2, function(x) x / max(x))
plot_surface(S, ages = ages, years = years, name = "S")

```


Row {.tabset}
--------------------------------------------------------------------------------

### RV survey catchability

```{r}

q <- exp(fit$rep$log_RV_Qa + log(fit$tmb.data$trawl_units))
plot_surface(q, ages = ages, years = years, name = "q")

```

### Proportion of the stock in Smith Sound

```{r}
p <- matrix(0, nrow = length(ages), ncol = length(years),
            dimnames = list(ages, years))
ss_p <- fit$rep$SSD
ss_years <- fit$tmb.data$SS_years
ss_ages <- fit$tmb.data$SS_ages
rownames(ss_p) <- ss_ages
colnames(ss_p) <- ss_years
p[as.character(ss_ages), as.character(ss_years)] <- ss_p
plot_surface(p, ages = ages, years = years, name = "p")

```


### Sentinel gillnet survey catchability

```{r}

log_qy <- t(replicate(length(fit$tmb.data$SN_ages), fit$rep$SN_GN_Qy))
log_qa <- fit$rep$log_SN_GN_Qa
q <- exp(log_qy + log_qa)
plot_surface(q, ages = fit$tmb.data$SN_ages,
             years = fit$tmb.data$SN_years,
             name = "q")

```


Trends
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Stock status

```{r}

## Note: biomass is in tonnes and numbers are in thousands
bms <- rbind(data.frame(metric = "SSB", tabs$log_ssb),
             data.frame(metric = "Ages 2+", tabs$log_biomass))
abn <- rbind(data.frame(metric = "Age 2", tabs$log_recruitment),
             data.frame(metric = "Ages 2+", tabs$log_abundance))

bms_plot <- trans_est(bms) %>%
  plot_trend(ylab = "Biomass (t)", group = "metric", col = cols,
             annotate = TRUE)

abn_plot <- trans_est(abn, scale = 0.001) %>%
  plot_trend(ylab = "Abundance", group = "metric", col = cols,
             annotate = TRUE)

blim_plot <- trans_est(tabs$log_ssb_lrp) %>%
  plot_trend(ylab = "SSB/Blim", annotate = TRUE, col = cols) %>%
  add_segments(x = min_year, xend = max_year + 1, y = 1, yend = 1, color = I("black"),
               linetype = I(3), name = "Blim", text = NULL, hoverinfo = "none") %>%
  add_text(x = max_year + 1.2, y = 1, text = paste(round(fit$rep$blim / 1000), "kt"),
           color = I("black"), textposition = "right", hoverinfo = "none")

subplot(abn_plot, bms_plot, blim_plot, nrows = 3, shareX = TRUE, titleY = TRUE)


```

### Abundance at age

```{r}
plot_surface(fit$rep$N_matrix * 1000, ages = ages, years = years_plus1, name = "N")
```

### Biomass at age

```{r}
plot_surface(fit$rep$biomass_matrix, ages = ages, years = years_plus1, name = "Biomass")
```

### SSB at age

```{r}
plot_surface(fit$rep$ssb_matrix, ages = ages, years = years_plus1, name = "SSB")
```


Row {.tabset}
--------------------------------------------------------------------------------

### Mortality Rates


```{r}

f <- data.frame(metric = "Ages 5+", tabs$log_aveF)
z <- data.frame(metric = "Ages 5+", tabs$log_aveZ)
m <- data.frame(metric = "Ages 5+", tabs$log_aveM)

z_plot <- trans_est(z) %>%
  plot_trend(ylab = "Average Z", group = "metric",
             annotate = TRUE, col = cols)

m_plot <- trans_est(m) %>%
  plot_trend(ylab = "Average M", group = "metric",
             annotate = TRUE, col = cols)

f_plot <- trans_est(f) %>%
  plot_trend(ylab = "Average F", group = "metric",
             annotate = TRUE, col = cols)

subplot(z_plot, m_plot, f_plot, nrows = 3, shareX = TRUE, titleY = TRUE)


```

### Z at age

```{r}
plot_surface(fit$rep$Z_matrix, ages = ages, years = years, name = "Z")
```

### M at age

```{r}
plot_surface(fit$rep$Mpe_matrix, ages = ages, years = years, name = "M")
```

### F at age

```{r}
plot_surface(fit$rep$F_matrix, ages = ages, years = years, name = "F")
```

### Z, M and F

```{r}
plot_zmf_surface(z = fit$rep$Z_matrix, m = fit$rep$Mpe_matrix, f = fit$rep$F_matrix,
                 ages = ages, years = years)
```

> Z = purples, M = blues, F = reds


### Process error

```{r}

pe <- fit$rep$pe
plot_surface(pe, years = c(years, fit$tmb.data$proj_years)[-1], ages = 2:8,
             name = "pe", col = RColorBrewer::brewer.pal(9, "RdBu")) %>%
  add_surface(matrix(0, nrow = nrow(pe), ncol = ncol(pe)), showscale = FALSE,
              color = I("black"), opacity = 0.8)

```


### Process error (bubble plot)

```{r}
pe <- tidy_mat(fit$rep$pe, years = c(years, fit$tmb.data$proj_years)[-1],
               ages = 2:8, value = "res")
bubble_plot(pe)
```




Retro {`r if (is.null(fit$retro)) ".hidden"`}
================================================================================

Row
--------------------------------------------------------------------------------

### Stock status

```{r, eval = !is.null(fit$retro)}

bms_plot <- trans_est(retro_tabs$log_ssb) %>%
  plot_retro(ylab = "SSB (t)", lwd = 1, col = cols[1])

abn_plot <- trans_est(retro_tabs$log_recruitment, scale = 0.001) %>%
  plot_retro(ylab = "Recruitment (age 2)", lwd = 1, col = cols[1])

blim_plot <- trans_est(retro_tabs$log_ssb_lrp) %>%
  plot_retro(ylab = "SSB/Blim", lwd = 1, col = cols[1]) %>%
  add_segments(x = min_year, xend = max_year + 1, y = 1, yend = 1, color = I("black"),
               linetype = I(3), name = "Blim", text = NULL, hoverinfo = "none")

subplot(abn_plot, bms_plot, blim_plot, nrows = 3, shareX = TRUE, titleY = TRUE)


```


Row
--------------------------------------------------------------------------------

### Mortality Rates


```{r, eval = !is.null(fit$retro)}

z_plot <- trans_est(retro_tabs$log_aveZ) %>%
  plot_retro(ylab = "Average Z (ages 5+)", lwd = 1, col = cols[1])

m_plot <- trans_est(retro_tabs$log_aveM) %>%
  plot_retro(ylab = "Average M (ages 5+)", lwd = 1, col = cols[1])

f_plot <- trans_est(retro_tabs$log_aveF) %>%
  plot_retro(ylab = "Average F (ages 5+)", lwd = 1, col = cols[1])

subplot(z_plot, m_plot, f_plot, nrows = 3, shareX = TRUE, titleY = TRUE)


```


Comps {`r if (is.null(tmp$comp)) ".hidden"`}
================================================================================

Row
--------------------------------------------------------------------------------

### Stock status

```{r, eval = !is.null(tmp$comp)}

abn_plot <- trans_est(comp_tabs$log_recruitment, scale = 0.001) %>% 
  plot_comps(ylab = "Recruitment (age 2)", col = cols)

bms_plot <- trans_est(comp_tabs$log_ssb) %>% 
  plot_comps(ylab = "SSB (t)", col = cols, showlegend = FALSE)

blim_plot <- trans_est(comp_tabs$log_ssb_lrp) %>%
  plot_comps(ylab = "SSB/Blim", col = cols, showlegend = FALSE) %>%
  add_segments(x = min_year, xend = max_year + 1, y = 1, yend = 1, color = I("black"),
               linetype = I(3), name = "Blim", text = NULL, hoverinfo = "none", showlegend = FALSE)

subplot(abn_plot, bms_plot, blim_plot, nrows = 3, shareX = TRUE, titleY = TRUE)

```


Row
--------------------------------------------------------------------------------

### Mortality Rates

```{r, eval = !is.null(tmp$comp)}

z_plot <- trans_est(comp_tabs$log_aveZ) %>%
  plot_comps(ylab = "Average Z (ages 5+)", col = cols)

m_plot <- trans_est(comp_tabs$log_aveM) %>%
  plot_comps(ylab = "Average M (ages 5+)", col = cols, showlegend = FALSE)

f_plot <- trans_est(comp_tabs$log_aveF) %>%
  plot_comps(ylab = "Average F (ages 5+)", col = cols, showlegend = FALSE)

subplot(z_plot, m_plot, f_plot, nrows = 3, shareX = TRUE, titleY = TRUE)

```


Productivity
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Recruitment

```{r}
trans_est(tabs$log_recruitment, scale = 0.001) %>%
  plot_trend(ylab = "Recruitment", col = cols[1])
```

### SSB

```{r}
trans_est(tabs$log_ssb) %>%
  plot_trend(ylab = "SSB (t)", col = cols[1])
```

### RPS

```{r}
trans_est(tabs$log_rps) %>%
  filter(year >= min_year + min(ages)) %>% 
  plot_trend(ylab = "RPS (thousand / tonne)", col = cols[1]) %>% 
  layout(xaxis = list(range = c(min_year, max_year + 1)))
```

### SSB x Recruitment

```{r}

ssb <- trans_est(tabs$log_ssb)
rec <- trans_est(tabs$log_recruitment, scale = 0.001)
rps <- trans_est(tabs$log_rps)
names(ssb) <- paste0("ssb_", names(ssb))
names(rec) <- paste0("rec_", names(rec))
names(rps) <- paste0("rps_", names(rps))
ssb$year <- ssb$ssb_year + min(ages)
rec$year <- rec$rec_year
rps$year <- rps$rps_year
sr <- merge(ssb, rec, by = "year")
sr <- merge(sr, rps, by = "year")
sr$lab <- paste0("Recruitment year: ", sr$rec_year, "<br>SSB year: ", sr$ssb_year)

plot_xy_errorbar(sr, x = ~ssb_est, y = ~rec_est,
                 x_lwr = ~ssb_lwr, x_upr = ~ssb_upr,
                 y_lwr = ~rec_lwr, y_upr = ~rec_upr,
                 text = ~lab, xlab = "SSB (t)", ylab = "Recruitment",
                 col = cols[1])

```

### SSB x RPS

```{r}
p <- plot_xy_errorbar(sr, x = ~ssb_est, y = ~rps_est,
                 x_lwr = ~ssb_lwr, x_upr = ~ssb_upr,
                 y_lwr = ~rps_lwr, y_upr = ~rps_upr,
                 text = ~lab, xlab = "SSB (t)", ylab = "RPS (thousand / tonne)",
                 col = cols[1])
p
```

### log(SSB) x log(RPS)

```{r}
p %>% layout(yaxis = list(type = "log"),
             xaxis = list(type = "log"))
```



```{r}

message("Bits of the projection code is currently not working. Specifically the plots that require the frame argument in plotly.")

```


<!-- Assumptions  {data-navmenu="Projections" .storyboard} -->
<!-- ================================================================================ -->


<!-- ### Assume the same selectivity curve as estimated by NCAM in the terminal year and apply catch multipliers -->

<!-- ```{r} -->

<!-- Cp <- fit$tmb.data$Cp -->
<!-- Cp_string <- text_c(Cp) -->
<!-- Lp <- round(Cp * tail(fit$rep$pred_catch_wt, 1)) -->
<!-- Lp_string <- paste(text_c(Lp), "t") -->

<!-- tidy_mat(fit$rep$F_matrix, ages = ages, years = years, value = "F") %>% -->
<!--   filter(year >= max(years) - 4) %>% -->
<!--   plot_ly(x = ~age, y = ~F, color = ~factor(year), colors = rev(cols)) %>% -->
<!--   add_lines(alpha = 0.5) %>% -->
<!--   filter(year == max(years)) %>% -->
<!--   add_lines(showlegend = FALSE, line = list(width = 3)) %>% -->
<!--   layout(xaxis = list(title = "Age")) -->

<!-- ``` -->


<!-- *** -->
<!-- - The following catch multipliers were applied: `r #Cp_string` -->
<!-- - This translates to `r #Lp_string` of catch in the projection years -->


<!-- ### Assume natural mortality converges on the long-term mean, excluding the M spike between 1991 - 1994 -->

<!-- ```{r} -->

<!-- if (all(fit$tmb.data$Mp_mult != 1)) stop("TODO: make the mortality multiplier projection documentation dynamic") -->

<!-- aveM <- tabs$log_aveM -->
<!-- aveM <- exp(mean(aveM$est[!aveM$year %in% 1991:1994])) -->

<!-- trans_est(tabs$log_aveM) %>% -->
<!--   plot_trend(ylab = "Average M", col = cols[1]) %>% -->
<!--   add_segments(x = 1995, xend = max(years) + 3, y = aveM, yend = aveM, -->
<!--                name = "long-term mean", color = I("black"), line = list(width = 1)) %>% -->
<!--   add_segments(x = 1990, xend = 1995, y = aveM, yend = aveM, -->
<!--                name = "long-term mean", color = I("black"), -->
<!--                line = list(width = 1, dash = "dot")) %>% -->
<!--   add_segments(x = min(years), xend = 1990, y = aveM, yend = aveM, -->
<!--                name = "long-term mean", color = I("black"), line = list(width = 1)) %>% -->
<!--   add_text(x = max(years) + 0.2, y = aveM, text = "long-term mean", textposition = "bottom right", -->
<!--            color = I("black")) %>% -->
<!--   layout(xaxis = list(range = c(min(years), max(years) + 3))) -->


<!-- ``` -->


<!-- ### Assume a relationship between recruits per spawner and number of spawners to project recruits in the future -->

<!-- ```{r} -->

<!-- if (fit$tmb.data$Rp_mode != 3) stop("TODO: make the recruitment mode documentation dynamic") -->

<!-- rps_tab <- tabs$log_rps -->
<!-- names(rps_tab) <- c("year", "rps", "rps_sd", "rps_lwr", "rps_upr") -->
<!-- rps_tab <- rps_tab[rps_tab$year >= 1985, ] -->
<!-- rps_tab$year <- rps_tab$year - 2 # scale back two year to allign with spawners that produced the recruits -->
<!-- ssa_tab <- tabs$log_ssa -->
<!-- names(ssa_tab) <- c("year", "ssa", "ssa_sd", "ssa_lwr", "ssa_upr") -->
<!-- d <- merge(ssa_tab, rps_tab, by = "year") -->
<!-- rec_tab <- tabs$log_recruitment -->
<!-- names(rec_tab) <- c("year", "rec", "rec_sd", "rec_lwr", "rec_upr") -->
<!-- rec_tab <- rec_tab[rec_tab$year >= 1985, ] -->
<!-- rec_tab$year <- rec_tab$year - 2 # scale back two years -->
<!-- d <- merge(d, rec_tab, by = "year") -->
<!-- d$excluded <- d$year %in% 1991:1994 -->

<!-- sub_d <- d[!d$year %in% 1991:1994, ] -->
<!-- lin_rel <- lm(rps ~ ssa, data = sub_d) -->
<!-- # coefficients(lin_rel) -->

<!-- preds <- data.frame(year = NA, rps_sd = NA, ssa_sd = NA, ssa = seq(min(d$ssa), max(d$ssa), length.out = 100)) -->
<!-- preds$fits <- predict(lin_rel, newdata = preds) -->
<!-- preds$excluded <- FALSE -->

<!-- plot_ly(data = d, x = ~ssa, y = ~rps, text = ~year, -->
<!--         type = "scatter", mode = "markers", name = "est", -->
<!--         color = ~excluded, colors = c(cols[2], "grey"), -->
<!--         error_y = list(array = ~ qnorm(0.975) * rps_sd, -->
<!--                        width = 0, thickness = 1), -->
<!--         error_x = list(array = ~ qnorm(0.975) * ssa_sd, -->
<!--                        width = 0, thickness = 1)) %>% -->
<!--   add_text(text = ~year, textfont = list(color = toRGB("grey50")), textposition = "top right", -->
<!--            error_y = list(visible = FALSE), -->
<!--            error_x = list(visible = FALSE)) %>% -->
<!--   layout(title = "Spawners vs Recruits / Spawner", -->
<!--          xaxis = list(title = "log(Spawners)"), -->
<!--          yaxis = list(title = "log(Recruits / Spawner)", zerolinecolor = toRGB("lightgrey")), -->
<!--          showlegend = FALSE) %>% -->
<!--   add_lines(data = preds, x = ~ssa, y = ~fits, name = "fit", color = I(cols[1])) -->

<!-- ``` -->

<!-- *** -->
<!-- - Grey points indicate years excluded from the regressionn -->


<!-- ### Assume averages weights and proportions mature from the last three years -->

<!-- ```{r} -->

<!-- mat_p <- tidy_mat(fit$tmb.data$mat, ages = factor(ages), years = years, value = "mat") %>% -->
<!--   filter(year >= max(years) - 2) %>% -->
<!--   plot_ly(x = ~age, y = ~mat, color = ~factor(year), colors = rev(cols)) %>% -->
<!--   add_lines(alpha = 0.5) %>% -->
<!--   group_by(age) %>% -->
<!--   summarise(mat = mean(mat), year = "3y mean") %>% -->
<!--   add_lines(line = list(width = 3)) %>% -->
<!--   layout(xaxis = list(title = "Age"), -->
<!--          yaxis = list(title = "Proportion mature")) -->

<!-- wt_p <- tidy_mat(fit$tmb.data$weight, ages = factor(ages), years = years, value = "weight") %>% -->
<!--   filter(year >= max(years) - 2) %>% -->
<!--   plot_ly(x = ~age, y = ~weight, color = ~factor(year), colors = rev(cols), -->
<!--           showlegend = FALSE) %>% -->
<!--   add_lines(alpha = 0.5) %>% -->
<!--   group_by(age) %>% -->
<!--   summarise(weight = mean(weight), year = "3y mean") %>% -->
<!--   add_lines(line = list(width = 3)) %>% -->
<!--   layout(xaxis = list(title = "Age"), -->
<!--          yaxis = list(title = "Weight (kg)")) -->

<!-- subplot(mat_p, wt_p, titleY = TRUE, titleX = TRUE) -->

<!-- ``` -->


<!-- Past projections {data-navmenu="Projections" `r if (is.null(tmp$last)) ".hidden"`} -->
<!-- ================================================================================ -->


<!-- ### Catch multiplier projections for SSB / Blim from the last RAP -->

<!-- ```{r, eval = !is.null(tmp$last)} -->

<!-- d <- trans_est(last_tabs$Cproj_log_ssb_lrp) -->
<!-- d$scenario <- factor(d$scenario) -->
<!-- d <- d[d$year <= max(years) + 1, ] -->

<!-- past_d <- trans_est(last_tabs$log_ssb_lrp) -->
<!-- past_d <- lapply(levels(d$scenario), function(s) data.frame(past_d, scenario = s)) -->
<!-- past_d <- do.call(rbind, past_d) -->
<!-- d <- rbind(past_d, d) -->
<!-- xlim <- c(max(last$tmb.data$years) - 5.1, max(years) + 1.1) -->
<!-- ylim <- range(d[d$year >= xlim[1] & d$year <= xlim[2], c("est", "lwr", "upr"), ]) -->

<!-- current_d <- trans_est(tabs$log_ssb_lrp) -->
<!-- current_d <- lapply(levels(d$scenario), function(s) data.frame(current_d, scenario = s)) -->
<!-- current_d <- do.call(rbind, current_d) -->
<!-- current_d$model <- "current RAP" -->
<!-- d$model <- "last RAP" -->
<!-- d <- rbind(d, current_d) -->

<!-- plot_proj(data = d, xlim = xlim, ylim = ylim, ylab = "SSB/Blim", group = "model", -->
<!--           vline = max(last$tmb.data$years) + 1, hline = 1, col = cols, showlegend = TRUE) -->

<!-- ``` -->




<!-- Results {data-navmenu="Projections" `r if (is.null(tmp$last)) ".hidden"`} -->
<!-- ================================================================================ -->


<!-- Row {.tabset} -->
<!-- -------------------------------------------------------------------------------- -->


<!-- ### Catch multiplier projections for SSB~yp~ / SSB~`r max(years) + 1`~ -->

<!-- ```{r} -->

<!-- d <- trans_est(tabs$Cproj_log_ssb_ratio) -->
<!-- d[, c("est", "lwr", "upr")] <- (d[, c("est", "lwr", "upr")] - 1) * 100 -->
<!-- d$scenario <- factor(d$scenario) -->
<!-- xlim <- c(max(years) + 0.9, max(years) + 4.1) -->
<!-- ylim <- range(d[d$year >= xlim[1] & d$year <= xlim[2], c("est", "lwr", "upr"), ]) -->

<!-- # plot_proj(data = d, xlim = xlim, ylim = ylim, ylab = "Percent growth", ticksuffix = "%", -->
<!-- #           vline = max(years) + 1, col = cols[1]) %>% -->
<!-- #   layout(yaxis = list(tickvals = seq(-200, 200, by = 25))) -->
<!-- message("plot_proj not working properly at the moment") -->

<!-- ``` -->



<!-- ### SSB / Blim -->

<!-- ```{r} -->

<!-- d <- trans_est(tabs$Cproj_log_ssb_lrp) -->
<!-- d$scenario <- factor(d$scenario) -->

<!-- past_d <- trans_est(tabs$log_ssb_lrp) -->
<!-- past_d <- lapply(levels(d$scenario), function(s) data.frame(past_d, scenario = s)) -->
<!-- past_d <- do.call(rbind, past_d) -->
<!-- d <- rbind(past_d, d) -->
<!-- xlim <- c(max(years) - 2.1, max(years) + 4.1) -->
<!-- ylim <- range(d[d$year >= xlim[1] & d$year <= xlim[2], c("est", "lwr", "upr"), ]) -->

<!-- # plot_proj(data = d, xlim = xlim, ylim = ylim, ylab = "SSB/Blim", -->
<!-- #           vline = max(years) + 1, hline = 1, col = cols[1]) -->
<!-- message("plot_proj not working properly at the moment") -->

<!-- ``` -->


<!-- Row {.tabset} -->
<!-- -------------------------------------------------------------------------------- -->

<!-- ### Prob(SSB~yp~ &ge; SSB~`r max(years) + 1`~) -->

<!-- ```{r} -->

<!-- growth <- tabs$Cproj_log_ssb_ratio -->
<!-- growth$p0 <- 1 - pnorm(0, mean = growth$est, sd = growth$sd) -->

<!-- d <- growth[growth$year != max(years) + 1, ] -->
<!-- d$scenario <- factor(d$scenario) -->
<!-- plot_ly(data = d, x = ~year, y = ~scenario, z = ~p0) %>% -->
<!--   add_heatmap() %>% -->
<!--   add_annotations(x = ~year, y = ~scenario, text = ~round(p0, 2), -->
<!--                   showarrow = FALSE, font = list(color = "white")) %>% -->
<!--   colorbar(title = "P", limits = c(0, 1)) %>% -->
<!--   layout(yaxis = list(title = "Catch multiplier"), -->
<!--          xaxis = list(title = "Year")) -->

<!-- ``` -->


<!-- ### Prob(SSB~yp~ &ge; B~lim~) -->

<!-- ```{r} -->

<!-- growth <- tabs$Cproj_log_ssb_lrp -->
<!-- growth$p0 <- 1 - pnorm(0, mean = growth$est, sd = growth$sd) -->

<!-- d <- growth[growth$year != max(years) + 1, ] -->
<!-- d$scenario <- factor(d$scenario) -->
<!-- plot_ly(data = d, x = ~year, y = ~scenario, z = ~p0) %>% -->
<!--   add_heatmap() %>% -->
<!--   add_annotations(x = ~year, y = ~scenario, text = ~round(p0, 2), -->
<!--                   showarrow = FALSE, font = list(color = "white")) %>% -->
<!--   colorbar(title = "P", limits = c(0, 1)) %>% -->
<!--   layout(yaxis = list(title = "Catch multiplier"), -->
<!--          xaxis = list(title = "Year")) -->

<!-- ``` -->


Inputs {data-navmenu="Tables"}
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Landings

```{r}
kable(inputs$landings, caption = "Reported landings (t) of cod from NAFO Divs. 2J+3KL from 1959 onward")
```


### Catch at age

```{r}
kable(inputs$catch.num, caption = "Catch numbers-at-age (thousands) for the commercial cod fishery in NAFO Divs. 2J+3KL.")
```

<!-- ### Monthly landings -->

<!-- ```{r} -->
<!-- d <- inputs$catch.month -->
<!-- dimnames(d) <- list(year = rownames(d), month = month.name) -->
<!-- kable(d, caption = "Monthly reported landings of cod from NAFO Divs. 2J+3KL.") -->
<!-- ``` -->

### RV index

```{r}
d <- data.table::dcast(inputs$index, year ~ age, value.var = "index")
mat <- d[, as.character(2:14)]
rownames(mat) <- d$year
kable(mat, caption = "Mean number of cod per tow at age in the index strata for the autumn DFO RV bottom-trawl surveys of NAFO Divs. 2J+3KL.", digits = 3)
```

### SN index

```{r}
d <- data.table::dcast(inputs$sentinel, year ~ AGE, value.var = "EST")
mat <- d[, as.character(3:10)]
rownames(mat) <- d$year
kable(mat, caption = 'Standardized age-disaggregated sentinel gill-net (5 1/2" mesh) catch rates (fish / net) of cod in NAFO Divs. 2J+3KL.', digits = 3)
```

### SS index

```{r}
d <- inputs$SS.bms[, c("Year", "month", "Biomass", "se2")]
names(d) <- c("Year", "Month", "Biomass", "SE^2^")
kable(d, caption = "Acoustic biomass estimates (t) for Smith Sound, Trinity Bay, from Rose et al. (2011).")
```

### SS age composition

```{r}
kable(inputs$SS_agecomps, caption = "Age composition of cod sampled during acoustic surveys in Smith Sound during 1995-2003. For details see Rose et al. 2011.")
```

### Weight at age

```{r}
d <- inputs$pwts
d <- d[d$year <= max(inputs$index$year), ]
d <- data.table::dcast(d, year ~ age, value.var = "weight")
mat <- d[, as.character(2:14)]
rownames(mat) <- d$year
kable(mat, caption = "Beginning of year weight-at-age estimates (kg) from a generalized Von Bertalanffy (VonB2) growth model described in Cadigan (2016) fitted by cohort to average weight at age data for cod from autumn bottom-trawl surveys in Division 2J+3KL.", digits = 3)
```

### Maturity at age

```{r}
d <- inputs$mats
d <- d[d$year <= max(inputs$index$year), ]
d <- data.table::dcast(d, year ~ age, value.var = "mat")
mat <- d[, as.character(2:14)]
rownames(mat) <- d$year
kable(mat, caption = "Estimated proportions mature for female cod from NAFO Div. 2J+3KL from DFO RV autumn bottom trawl surveys. Estimates were obtained from a cohort-specific binomial logistic regression model fitted to observed proportions mature at age.", digits = 3)
```

### Tag summary

```{r}
d <- inputs$mtag1 %>% 
  group_by(rel_year, exp) %>% 
  summarise(NAFO = unique(div),
            Nrel = sum(unique(released)), 
            Ncap = sum(recaptured))
names(d) <- c("Year", "Experiment", "NAFO division", "N~released~", "N~recaptured~")
kable(d, caption = "Number of tagged cod released and recaptured by experiment.")
```


Settings {data-navmenu="Tables"}
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Catch bounds

```{r}
d <- data.frame(Year = fit$tmb.data$years, Lower = fit$tmb.data$LRL, Upper = fit$tmb.data$LRU)
kable(d, caption = "Lower and upper catch multipliers used for generating catch bounds.")
```

### Baseline M

```{r}
m <- fit$tmb.data$M_matrix
rownames(m) <- ages
colnames(m) <- years
kable(t(m), caption = "Baseline levels of natural mortality (M) at age.")
```


Output {data-navmenu="Tables"}
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Parameter estimates

```{r}

par_tab <- tidy_pars(fit)
rownames(par_tab) <- NULL
options(knitr.kable.NA = '')
kable(par_tab, digits = 3, caption = "Estimates of model fits, population parameters and variance parameters, with coefficients of variation.")

```

> Note: RV = DFO Research Vessel survey; SN = Sentinel survey; SS = Smith Sound; D = proportion of stock in Smith Sound; NB = negative binomial

### Parameter estimates (retro)

```{r}

par_tabs <- lapply(names(fit$retro), function(nm) {
  d <- data.frame(tyear = as.numeric(nm), tidy_pars(fit$retro[[nm]]))
  d$id <- seq(nrow(d))
  d
})
par_tabs <- do.call(rbind, par_tabs)
final_par_tab <- data.frame(tyear = max(years), par_tab)
final_par_tab$id <- seq(nrow(final_par_tab))
par_tabs <- rbind(par_tabs, final_par_tab)
par_tabs <- par_tabs[order(par_tabs$id, par_tabs$tyear), ]
par_tabs <- par_tabs[, c("Quantity", "Symbol", "tyear", "Estimate", "CV")]
par_tabs$Quantity <- as.character(par_tabs$Quantity)
par_tabs$Quantity[duplicated(par_tabs$Quantity)] <- ""
par_tabs$Symbol <- as.character(par_tabs$Symbol)
par_tabs$Symbol[duplicated(par_tabs$Symbol)] <- ""
par_tabs <- par_tabs[, c("Quantity", "Symbol", "tyear", "Estimate", "CV")]
rownames(par_tabs) <- NULL
names(par_tabs)[names(par_tabs) == "tyear"] <- "Terminal Year"

kable(par_tabs, digits = 3, caption = "Estimates of retrospective model fits, population parameters and variance parameters, with coefficients of variation.")

```

> Note: RV = DFO Research Vessel survey; SN = Sentinel survey; SS = Smith Sound; D = proportion of stock in Smith Sound; NB = negative binomial

### Stock size

```{r}

tab_name <- c("log_abundance" = "Abundance (millions)", 
              "log_recruitment" = "Recruits (age 2; millions)", 
              "log_biomass" = "Biomass (kt)", 
              "log_ssa" = "Spawners (millions)", 
              "log_ssb" = "SSB (kt)", 
              "log_ssb_lrp" = "SSB/Blim n(%)")

nms <- names(tab_name)
status_tab <- trans_est(tabs[[nms[1]]], scale = 1000)[, c("year", "est", "lwr", "upr")]
names(status_tab) <- c("Year", paste(tab_name[[nms[1]]], c("", "L 95% CI", "U 95% CI")))

for (n in nms[-1]) {
  s <- ifelse(n == "log_ssb_lrp", 0.01, 1000)
  tab <- trans_est(tabs[[n]], scale = s)[, c("year", "est", "lwr", "upr")]
  names(tab) <- c("Year", paste(tab_name[[n]], c("", "L 95% CI", "U 95% CI")))
  status_tab <- merge(status_tab, tab, by = "Year")
}

knitr::kable(status_tab, digits = 0, caption = "Northern cod stock size estimates with lower (L) and upper (U) 95% confidence intervals (CI)")

```


### Rates

```{r}

tab_name <- c("log_aveZ" = "Average Z (ages 5+)", 
              "log_aveM" = "Average M (ages 5+)", 
              "log_aveF" = "Average F (ages 5+)")

nms <- names(tab_name)
rate_tab <- trans_est(tabs[[nms[1]]])[, c("year", "est", "lwr", "upr")]
names(rate_tab) <- c("Year", paste(tab_name[[nms[1]]], c("", "L 95% CI", "U 95% CI")))

for (n in nms[-1]) {
  tab <- trans_est(tabs[[n]], scale = 1)[, c("year", "est", "lwr", "upr")]
  names(tab) <- c("Year", paste(tab_name[[n]], c("", "L 95% CI", "U 95% CI")))
  rate_tab <- merge(rate_tab, tab, by = "Year")
}

knitr::kable(rate_tab, digits = 3, caption = "Northern cod stock mortality rate estimates with lower (L) and upper (U) 95% confidence intervals (CI)")

```


### Abundance-at-age

```{r}
N_matrix <- fit$rep$N_matrix
dimnames(N_matrix) <- list(age = ages, year = years_plus1)
knitr::kable(t(N_matrix) / 1000, caption = "Abundance-at-age estimates (millions).", digits = 2)
```

### Mature abundance-at-age

```{r}
ssa_matrix <- fit$rep$ssa_matrix
dimnames(ssa_matrix) <- list(age = ages, year = years_plus1)
knitr::kable(t(ssa_matrix) / 1000, caption = "Mature abundance-at-age estimates (millions).", digits = 2)
```


### Biomass-at-age

```{r}
B_matrix <- fit$rep$biomass_matrix
dimnames(B_matrix) <- list(age = ages, year = years_plus1)
knitr::kable(t(B_matrix) / 1000, caption = "Biomass-at-age estimates (kt).", digits = 2)
```

### Mature biomass-at-age

```{r}
ssb_matrix <- fit$rep$ssb_matrix
dimnames(ssb_matrix) <- list(age = ages, year = years_plus1)
knitr::kable(t(ssb_matrix) / 1000, caption = "Mature biomass-at-age estimates (kt).", digits = 2)
```

### Z-at-age

```{r}
Z_matrix <- fit$rep$Z_matrix
dimnames(Z_matrix) <- list(age = ages, year = years)
knitr::kable(t(Z_matrix), caption = "Z-at-age estimates.", digits = 3)
```

### M-at-age

```{r}
M_matrix <- fit$rep$Mpe_matrix
dimnames(M_matrix) <- list(age = ages, year = years)
M_matrix <- M_matrix[as.character(2:8), ]
rownames(M_matrix) <- c(as.character(2:7), "8+")
knitr::kable(t(M_matrix), caption = "M-at-age estimates.", digits = 3)
```

### F-at-age

```{r}
F_matrix <- fit$rep$F_matrix
dimnames(F_matrix) <- list(age = ages, year = years)
knitr::kable(t(F_matrix), caption = "F-at-age estimates.", digits = 3)
```



